<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title> Heart & Bones &copy; Club</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    body, html {
      margin: 0;
      padding: 0;
      overflow: hidden;
      background: #000;
      height: 100%;
      width: 100%;
    }
    #game-container {
      position: absolute;
      top: 50%;
      left: 50%;
      width: min(80vw, 400px);
      height: min(80vw, 400px);
      transform: translate(-50%, -50%);
    }
    canvas {
      display: block;
      width: 100%;
      height: 100%;
    }
    #frame {
      position: fixed;
      top: 70%;
      left: 51%;
      width: 155vw;
      height: 150vw;
      max-width: 1000px;
      max-height: 1000px;
      transform: translate(-50%, -50%);
      pointer-events: none;
      z-index: 999;
    }
      </style>
    </head>

<!--// Token-gate via (Polygon or BASE + Opensea API Check via hb-verify-nft.vercel.app)-->
<script type="module">
import { ethers } from "https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.esm.min.js";

const signatureMessage = "Sign this message to verify access to Interactive Mint.";

const allowedCollections = [
  { slug: "heartbones", chain: "base" },
  { slug: "heartandbones", chain: "matic" },
];

const allowedTokenIds = null; // e.g., [1, 2, 42] or null to allow any

function createAccessModal() {
  const modal = document.createElement("div");
  modal.id = "wallet-modal";
  modal.style.cssText = `
    position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
    background: rgba(0, 0, 0, 0.85); color: white; z-index: 9999;
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    font-family: sans-serif; text-align: center;
  `;
  modal.innerHTML = `
    <h2>Verify NFT Access</h2>
    <p id="modal-status">Connect your wallet to continue.</p>
    <button id="modal-connect" style="padding: 10px 20px; font-size: 1rem; margin-top: 1rem;">Connect Wallet</button>
  `;
  document.body.appendChild(modal);
  return modal;
}

async function ownsAnyApprovedNFT(address) {
  let ownedNFTs = [];

  for (const { slug, chain } of allowedCollections) {
    const url = `https://hb-verify-nft.vercel.app/api/check-nfts?chain=${chain}&address=${address}&slug=${slug}`;
    try {
      const res = await fetch(url);
      if (!res.ok) {
        console.warn(`⚠️ Failed request to ${url} - status: ${res.status}`);
        continue;
      }
      const data = await res.json();
      if (data.nfts && data.nfts.length > 0) {
        for (const nft of data.nfts) {
          const tokenId = parseInt(nft.identifier || nft.token_id || "0");
          if (!allowedTokenIds || allowedTokenIds.includes(tokenId)) {
            ownedNFTs.push(nft);
          }
        }
      }
    } catch (err) {
      console.error(`❌ Error fetching ${slug} on ${chain}:`, err);
    }
    await new Promise((r) => setTimeout(r, 1000));
  }

  if (ownedNFTs.length > 0) {
    sessionStorage.setItem("HB_nfts", JSON.stringify(ownedNFTs));
    return true;
  }

  return false;
}

async function verifyWalletAccess(statusEl) {
  try {
    if (!window.ethereum) {
      statusEl.textContent = "MetaMask is required to access this site.";
      return;
    }

    statusEl.textContent = "Requesting wallet connection...";
    const provider = new ethers.providers.Web3Provider(window.ethereum);
    await provider.send("eth_requestAccounts", []);
    const signer = provider.getSigner();
    const address = await signer.getAddress();

    statusEl.textContent = "Checking NFT ownership...";
    const ownsNFT = await ownsAnyApprovedNFT(address);

    if (ownsNFT) {
      const signature = await signer.signMessage(signatureMessage);
      if (signature) {
        sessionStorage.setItem("HB_multi_verified", "true");
        return true;
      }
    } else {
      statusEl.textContent = "You need a Heartbones or Heart & Bones NFT... Redirecting to OpenSea...";
      setTimeout(() => {
        window.location.href = "https://opensea.io/collection/heartbones";
      }, 3000);
    }
  } catch (err) {
    console.error(err);
    statusEl.textContent = "Verification failed. Try again.";
  }

  return false;
}

function displayOwnedNFTs() {
  const raw = sessionStorage.getItem("HB_nfts");
  if (!raw) return;

  const nfts = JSON.parse(raw);
  if (nfts.length === 0) return;

  const container = document.createElement("div");
  container.style = "display: flex; flex-wrap: wrap; gap: 1rem; justify-content: center; margin-top: 2rem;";

  nfts.forEach((nft) => {
    const card = document.createElement("div");
    card.style = "width: 150px; color: white; text-align: center;";
    card.innerHTML = `
      <img src="${nft.image_url}" alt="${nft.name}" style="width:100%; border-radius: 10px;" />
      <div style="margin-top: 0.5rem;">${nft.name || "NFT"}</div>
    `;
    container.appendChild(card);
  });

  document.body.appendChild(container);
}

function showSiteContent() {
  const modal = document.getElementById("wallet-modal");
  if (modal) modal.remove();
  document.body.style.overflow = "auto";

  // ✅ Display owned NFTs
  displayOwnedNFTs();

  // ✅ Auto-unlock iframe or content (if present)
  const iframe = document.querySelector("iframe[data-token-gated]");
  if (iframe) iframe.style.display = "block";

  const unlockSection = document.getElementById("gated-content");
  if (unlockSection) unlockSection.style.display = "block";
}

document.addEventListener("DOMContentLoaded", () => {
  if (sessionStorage.getItem("HB_multi_verified") === "true") {
    showSiteContent();
    return;
  }
//if (signature) {
  //sessionStorage.setItem("HB_multi_verified", "true");
  
  // 🔊 Play sound effect
  const music = document.getElementById("unlock-sfx");
  if (music) {
    music.play().catch(e => console.warn("🔇 Autoplay blocked", e));
  }

  return true;
}
  document.body.style.overflow = "hidden";
  const modal = createAccessModal();
  const connectBtn = document.getElementById("modal-connect");
  const statusEl = document.getElementById("modal-status");

  connectBtn.addEventListener("click", async () => {
    const verified = await verifyWalletAccess(statusEl);
    if (verified) showSiteContent();
  });
});
</script>
<body>
    <button id="music-toggle" style="
      position: absolute; top: 10px; right: 10px; z-index: 10000;
      padding: 6px 12px; font-size: 0.9rem;
      background: #222; color: #fff; border: 1px solid #fff; border-radius: 6px;
      cursor: pointer;
    ">🔊 Mute</button>
  <div id="game-container"></div>

  <img id="frame" src="frame+.png" alt="Game Frame">

  <!-- Load Phaser -->
  <script src="https://cdn.jsdelivr.net/npm/phaser@3.85.2/dist/phaser.js"></script>

  <!-- Load WalletConnect -->
  <script src="https://cdn.jsdelivr.net/npm/@walletconnect/web3-provider@1.6.6/dist/umd/index.min.js"></script>

  <!-- Load ethers.js UMD (for browser global use) -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>

  <!-- Load Web3Modal -->
  <script src="https://cdn.jsdelivr.net/npm/web3modal@1.9.7/dist/index.min.js"></script>

  <!-- Load custom game and wallet connection logic -->
  <script src="walletconnect.js"></script>
  <script type="module" src="game.js"></script>
<!--<audio id="unlock-music" src="assets/audio/coin-up.mp3" preload="auto"></audio>-->
<audio id="bgMusic" src="/coin-up.mp3" preload="auto" loop></audio>
  <footer style="color:gray; text-align: center; padding: 1rem;">
  &copy; FunFart Games. All rights reserved.  
  <br/>
  <small>
    Sound Effect by 
    <a href="https://pixabay.com/users/bobbeats-48369126/?utm_source=link-attribution&utm_medium=referral&utm_campaign=music&utm_content=290770" target="_blank" rel="noopener noreferrer">
      Xavier Reed
    </a> 
    from 
    <a href="https://pixabay.com/?utm_source=link-attribution&utm_medium=referral&utm_campaign=music&utm_content=290770" target="_blank" rel="noopener noreferrer">
      Pixabay
    </a>
  </small>
</footer>
</body>
</html>
