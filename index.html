<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title> Heart & Bones &copy; Club</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    body, html {
      margin: 0;
      padding: 0;
      overflow: hidden;
      background: #000;
      height: 100%;
      width: 100%;
    }
    #game-container {
      position: absolute;
      top: 50%;
      left: 50%;
      width: min(80vw, 400px);
      height: min(80vw, 400px);
      transform: translate(-50%, -50%);
    }
    canvas {
      display: block;
      width: 100%;
      height: 100%;
    }
    #frame {
      position: fixed;
      top: 70%;
      left: 51%;
      width: 155vw;
      height: 150vw;
      max-width: 1000px;
      max-height: 1000px;
      transform: translate(-50%, -50%);
      pointer-events: none;
      z-index: 999;
    }
  </style>
</head>

<!--// Token-gate via (Polygon or BASE + Opensea API Check)-->
<script type="module">
import { ethers } from "https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.esm.min.js";

const signatureMessage = "Sign this message to verify access to Digitalknuckles Portfolio.";
const openseaApi = "https://api.opensea.io/api/v2";

const allowedCollections = [
  { slug: "heartbones", chain: "base" },
  { slug: "heartandbones", chain: "matic" },
];

function createAccessModal() {
  const modal = document.createElement("div");
  modal.id = "wallet-modal";
  modal.style.cssText = `
    position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
    background: rgba(0, 0, 0, 0.85); color: white; z-index: 9999;
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    font-family: sans-serif; text-align: center;
  `;

  modal.innerHTML = `
    <h2>Verify NFT Access</h2>
    <p id="modal-status">Connect your wallet to continue.</p>
    <button id="modal-connect" style="padding: 10px 20px; font-size: 1rem; margin-top: 1rem;">Connect Wallet</button>
  `;

  document.body.appendChild(modal);
  return modal;
}

async function ownsAnyApprovedNFT(address) {
  for (const { slug, chain } of allowedCollections) {
    const url = `${openseaApi}/chain/${chain}/account/${address}/nfts?collection=${slug}`;

    try {
      console.log(`ðŸ” Checking ${slug} on ${chain} for address ${address}`);
      const res = await fetch(url);
      if (!res.ok) {
        console.warn(`âš ï¸ Failed request to ${url} - status: ${res.status}`);
        continue;
      }

      const data = await res.json();
      console.log(`ðŸ“¦ OpenSea ${slug} data:`, data);

      if (data.nfts && data.nfts.length > 0) {
        console.log(`âœ… NFT found in ${slug}`);
        return true;
      }
    } catch (err) {
      console.error(`âŒ Error fetching ${slug} on ${chain}:`, err);
    }

    await new Promise((r) => setTimeout(r, 1000)); // prevent rate limiting
  }

  return false;
}

async function verifyWalletAccess(statusEl) {
  try {
    if (!window.ethereum) {
      statusEl.textContent = "MetaMask is required to access this site.";
      return;
    }

    statusEl.textContent = "Requesting wallet connection...";
    const provider = new ethers.providers.Web3Provider(window.ethereum);
    await provider.send("eth_requestAccounts", []);
    const signer = provider.getSigner();
    const address = await signer.getAddress();

    statusEl.textContent = "Checking NFT ownership...";
    const ownsNFT = await ownsAnyApprovedNFT(address);

    if (ownsNFT) {
      const signature = await signer.signMessage(signatureMessage);
      if (signature) {
        sessionStorage.setItem("HB_multi_verified", "true");
        return true;
      }
    } else {
      statusEl.textContent = "You need a Heartbones or Heart & Bones NFT... Redirecting to OpenSea...";
      setTimeout(() => {
        window.location.href = "https://opensea.io/collection/heartandbones";
      }, 3000);
    }
  } catch (err) {
    console.error(err);
    statusEl.textContent = "Verification failed. Try again.";
  }

  return false;
}

function showSiteContent() {
  const modal = document.getElementById("wallet-modal");
  if (modal) modal.remove();
  document.body.style.overflow = "auto";
}

document.addEventListener("DOMContentLoaded", () => {
  if (sessionStorage.getItem("HB_multi_verified") === "true") {
    showSiteContent();
    return;
  }

  document.body.style.overflow = "hidden";
  const modal = createAccessModal();

  const connectBtn = document.getElementById("modal-connect");
  const statusEl = document.getElementById("modal-status");

  connectBtn.addEventListener("click", async () => {
    const verified = await verifyWalletAccess(statusEl);
    if (verified) showSiteContent();
  });
});
</script>
<body>

  <div id="game-container"></div>

  <img id="frame" src="frame+.png" alt="Game Frame">

  <!-- Load Phaser -->
  <script src="https://cdn.jsdelivr.net/npm/phaser@3.85.2/dist/phaser.js"></script>

  <!-- Load WalletConnect -->
  <script src="https://cdn.jsdelivr.net/npm/@walletconnect/web3-provider@1.6.6/dist/umd/index.min.js"></script>

  <!-- Load ethers.js UMD (for browser global use) -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>

  <!-- Load Web3Modal -->
  <script src="https://cdn.jsdelivr.net/npm/web3modal@1.9.7/dist/index.min.js"></script>

  <!-- Load custom game and wallet connection logic -->
  <script src="walletconnect.js"></script>
  <script type="module" src="game.js"></script>

</body>
</html>
