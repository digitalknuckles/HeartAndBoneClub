<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title> Heart & Bones&copy; Club</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    body, html {
      margin: 0;
      padding: 0;
      overflow: hidden;
      background: #000;
      height: 100%;
      width: 100%;
    }
    #game-container {
      position: absolute;
      top: 50%;
      left: 50%;
      width: min(80vw, 400px);
      height: min(80vw, 400px);
      transform: translate(-50%, -50%);
    }
    canvas {
      display: block;
      width: 100%;
      height: 100%;
    }
    #frame {
      position: fixed;
      top: 70%;
      left: 51%;
      width: 155vw;
      height: 150vw;
      max-width: 1000px;
      max-height: 1000px;
      transform: translate(-50%, -50%);
      pointer-events: none;
      z-index: 999;
    }
  </style>
</head>
<script type="module">
import { ethers } from "https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.esm.min.js";

// Updated contract details
const nftAddress = "0xc3D73e86738BA19A77fF2f073d009e721ef7ABB6"; // Heartbones ERC-721
const nftABI = ["function balanceOf(address owner) view returns (uint256)"];
const signatureMessage = "Sign this message to verify access to Hear & Bones Club.";

function createAccessModal() {
  const modal = document.createElement("div");
  modal.id = "wallet-modal";
  modal.style.cssText = `
    position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
    background: rgba(0, 0, 0, 0.85); color: white; z-index: 9999;
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    font-family: sans-serif; text-align: center;
  `;

  modal.innerHTML = `
    <h2>Verify NFT Access</h2>
    <p id="modal-status">Connect your wallet to continue.</p>
    <button id="modal-connect" style="padding: 10px 20px; font-size: 1rem; margin-top: 1rem;">Connect Wallet</button>
  `;

  document.body.appendChild(modal);
  return modal;
}

async function verifyWalletAccess(statusEl) {
  try {
    if (!window.ethereum) {
      statusEl.textContent = "MetaMask is required to access this site.";
      return;
    }

    statusEl.textContent = "Requesting wallet connection...";
    const provider = new ethers.providers.Web3Provider(window.ethereum);
    await provider.send("eth_requestAccounts", []);
    const signer = provider.getSigner();
    const userAddress = await signer.getAddress();

    statusEl.textContent = "Checking NFT ownership...";
    const contract = new ethers.Contract(nftAddress, nftABI, provider);
    const balance = await contract.balanceOf(userAddress);

    if (balance.toNumber() > 0) {
      const signature = await signer.signMessage(signatureMessage);
      if (signature) {
        sessionStorage.setItem("HB_verified", "true");
        return true;
      }
    } else {
      statusEl.textContent = "You need a Heartbones NFT... Redirecting to collection...";
      setTimeout(() => {
        window.location.href = "https://opensea.io/collection/heartbones";
      }, 3000);
    }
  } catch (err) {
    console.error(err);
    statusEl.textContent = "Verification failed. Try again.";
  }

  return false;
}

function showSiteContent() {
  const modal = document.getElementById("wallet-modal");
  if (modal) modal.remove();
  document.body.style.overflow = "auto"; // re-enable scrolling
}

document.addEventListener("DOMContentLoaded", () => {
  if (sessionStorage.getItem("HB_verified") === "true") {
    showSiteContent();
    return;
  }

  document.body.style.overflow = "hidden"; // lock scroll
  const modal = createAccessModal();

  const connectBtn = document.getElementById("modal-connect");
  const statusEl = document.getElementById("modal-status");

  connectBtn.addEventListener("click", async () => {
    const verified = await verifyWalletAccess(statusEl);
    if (verified) showSiteContent();
  });
});
</script>
<body>

  <div id="game-container"></div>

  <img id="frame" src="frame+.png" alt="Game Frame">

  <!-- Load Phaser -->
  <script src="https://cdn.jsdelivr.net/npm/phaser@3.85.2/dist/phaser.js"></script>

  <!-- Load WalletConnect -->
  <script src="https://cdn.jsdelivr.net/npm/@walletconnect/web3-provider@1.6.6/dist/umd/index.min.js"></script>

  <!-- Load ethers.js UMD (for browser global use) -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>

  <!-- Load Web3Modal -->
  <script src="https://cdn.jsdelivr.net/npm/web3modal@1.9.7/dist/index.min.js"></script>

  <!-- Load custom game and wallet connection logic -->
  <script src="walletconnect.js"></script>
  <script type="module" src="game.js"></script>

</body>
</html>
